<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings - Donotick Printer</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .settings-section {
      margin-bottom: 24px;
    }
    .settings-section:last-child {
      margin-bottom: 0;
    }
    .section-description {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-row.single {
      grid-template-columns: 1fr;
    }
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-inset);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle.active {
      background: var(--green);
      border-color: var(--green);
    }
    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: var(--text);
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle.active::after {
      transform: translateX(20px);
    }
    .toggle-label {
      font-size: 0.875rem;
      color: var(--text);
    }
    .password-field {
      position: relative;
    }
    .password-field input {
      padding-right: 40px;
    }
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }
    .password-toggle:hover {
      color: var(--text);
    }
    .save-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 0;
      border-top: 1px solid var(--border-subtle);
      margin-top: 20px;
    }
    .save-status {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }
    .save-status.success {
      color: var(--green);
    }
    .save-status.error {
      color: var(--red);
    }
    .test-section {
      background: var(--bg-inset);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }
    .test-section h4 {
      font-size: 0.875rem;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div class="logo">‚öôÔ∏è</div>
      <div>
        <h1>Settings</h1>
        <p class="sub">Configure your Donotick Printer Bridge</p>
      </div>
      <a href="/" class="back-link">
        ‚Üê Back to Dashboard
      </a>
    </header>

    <div class="grid">
      <div class="col-8">
        <!-- Donotick Settings -->
        <div class="card">
          <div class="card-header">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Donotick Connection</h3>
          </div>
          <div class="card-body">
            <p class="section-description">Connect to your Donotick server to fetch tasks.</p>
            
            <div class="form-row single">
              <div class="form-group">
                <label for="donotickBaseUrl">Server URL</label>
                <input id="donotickBaseUrl" type="text" placeholder="http://192.168.50.250:2021" />
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="donotickUsername">Username</label>
                <input id="donotickUsername" type="text" placeholder="your-username" />
              </div>
              <div class="form-group password-field">
                <label for="donotickPassword">Password</label>
                <input id="donotickPassword" type="password" placeholder="your-password" />
                <button type="button" class="password-toggle" onclick="togglePassword('donotickPassword')">üëÅ</button>
              </div>
            </div>
            
            <details style="margin-top: 12px;">
              <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.8125rem;">
                Advanced: Use API Token instead
              </summary>
              <div class="form-row single" style="margin-top: 12px;">
                <div class="form-group password-field">
                  <label for="donotickToken">API Token (legacy)</label>
                  <input id="donotickToken" type="password" placeholder="secretkey token" />
                  <button type="button" class="password-toggle" onclick="togglePassword('donotickToken')">üëÅ</button>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- Printer Settings -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Printer</h3>
          </div>
          <div class="card-body">
            <p class="section-description">Configure your Epson thermal printer connection.</p>
            
            <div class="form-row">
              <div class="form-group">
                <label for="printerIp">Printer IP Address</label>
                <input id="printerIp" type="text" placeholder="192.168.50.100" />
              </div>
              <div class="form-group">
                <label for="printerPort">Port</label>
                <input id="printerPort" type="number" value="9100" />
              </div>
            </div>
            
            <div class="test-section">
              <h4>Test Connection</h4>
              <div class="btn-group">
                <button id="btnPing">Check Connection</button>
                <button id="btnPrintTest">Print Test Page</button>
              </div>
              <div id="printerStatus" class="status-box" style="margin-top: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- Schedule Settings -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Schedule</h3>
          </div>
          <div class="card-body">
            <p class="section-description">Configure automatic printing times.</p>
            
            <div class="form-row">
              <div class="form-group">
                <label for="dailyPrintTime">Daily Auto-Print Time</label>
                <input id="dailyPrintTime" type="time" value="08:00" />
              </div>
              <div class="form-group">
                <label for="weeklyPrintTime">Weekly Summary Time</label>
                <input id="weeklyPrintTime" type="time" value="08:00" />
              </div>
            </div>
            
            <div class="form-row single">
              <div class="form-group">
                <label for="weeklyPrintDay">Weekly Summary Day</label>
                <select id="weeklyPrintDay">
                  <option value="0">Sunday</option>
                  <option value="1">Monday</option>
                  <option value="2">Tuesday</option>
                  <option value="3">Wednesday</option>
                  <option value="4">Thursday</option>
                  <option value="5">Friday</option>
                  <option value="6">Saturday</option>
                </select>
              </div>
            </div>
            
            <div class="info-row" style="margin-top: 16px;">
              <span class="info-label">Last Run</span>
              <span class="info-value" id="lastRun">Never</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Result</span>
              <span class="info-value" id="lastResult">--</span>
            </div>
          </div>
        </div>

        <!-- Trash Calendar Settings -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Trash Calendar</h3>
          </div>
          <div class="card-body">
            <p class="section-description">Configure waste collection calendar integration.</p>
            
            <div class="toggle-group">
              <div id="trashEnableToggle" class="toggle" onclick="toggleTrashEnable()"></div>
              <span class="toggle-label">Enable trash calendar integration</span>
            </div>
            
            <div class="form-row single" id="trashUrlGroup">
              <div class="form-group">
                <label for="trashIcalUrl">iCal Feed URL</label>
                <input id="trashIcalUrl" type="url" placeholder="https://example.com/calendar.ics" />
              </div>
            </div>
          </div>
        </div>

        <!-- Save Bar -->
        <div class="save-bar">
          <button id="btnSave" class="btn-primary">Save All Settings</button>
          <span id="saveStatus" class="save-status"></span>
        </div>
      </div>

      <div class="col-4">
        <div class="card">
          <div class="card-header">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Help</h3>
          </div>
          <div class="card-body">
            <div class="help-section">
              <h4>Donotick Server</h4>
              <p>Enter the URL of your Donotick instance, including the port (usually 2021).</p>
            </div>
            <div class="help-section">
              <h4>Authentication</h4>
              <p>Use your Donotick username and password for full API access including labels.</p>
            </div>
            <div class="help-section">
              <h4>Printer</h4>
              <p>Enter the IP address of your Epson thermal printer. Port is usually 9100 for ESC/POS.</p>
            </div>
            <div class="help-section">
              <h4>Schedule</h4>
              <p>Daily prints individual tasks each morning. Weekly summary prints on the configured day.</p>
            </div>
          </div>
        </div>

        <a href="/trash.html" class="nav-link">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          <span>Trash Calendar</span>
          <span class="arrow">‚Üí</span>
        </a>

        <a href="/logs.html" class="nav-link">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8"/>
          </svg>
          <span>Activity Log</span>
          <span class="arrow">‚Üí</span>
        </a>
      </div>
    </div>
  </div>

  <script>
    // Form elements
    const fields = {
      donotickBaseUrl: document.getElementById('donotickBaseUrl'),
      donotickUsername: document.getElementById('donotickUsername'),
      donotickPassword: document.getElementById('donotickPassword'),
      donotickToken: document.getElementById('donotickToken'),
      printerIp: document.getElementById('printerIp'),
      printerPort: document.getElementById('printerPort'),
      dailyPrintTime: document.getElementById('dailyPrintTime'),
      weeklyPrintTime: document.getElementById('weeklyPrintTime'),
      weeklyPrintDay: document.getElementById('weeklyPrintDay'),
      trashIcalUrl: document.getElementById('trashIcalUrl')
    };
    
    const trashEnableToggle = document.getElementById('trashEnableToggle');
    const trashUrlGroup = document.getElementById('trashUrlGroup');
    const printerStatus = document.getElementById('printerStatus');
    const saveStatus = document.getElementById('saveStatus');
    
    let trashEnabled = true;

    async function fetchJson(url, opts = {}) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function toggleTrashEnable() {
      trashEnabled = !trashEnabled;
      trashEnableToggle.classList.toggle('active', trashEnabled);
      trashUrlGroup.style.display = trashEnabled ? 'block' : 'none';
    }

    async function loadConfig() {
      try {
        const data = await fetchJson('/api/config');
        const cfg = data.config;
        
        fields.donotickBaseUrl.value = cfg.donotickBaseUrl || '';
        fields.donotickUsername.value = cfg.donotickUsername || '';
        fields.donotickPassword.value = cfg.donotickPassword || '';
        fields.donotickToken.value = cfg.donotickToken || '';
        fields.printerIp.value = cfg.printerIp || '';
        fields.printerPort.value = cfg.printerPort || 9100;
        fields.dailyPrintTime.value = cfg.dailyPrintTime || '08:00';
        fields.weeklyPrintTime.value = cfg.weeklyPrintTime || '08:00';
        fields.weeklyPrintDay.value = cfg.weeklyPrintDay ?? 0;
        fields.trashIcalUrl.value = cfg.trashIcalUrl || '';
        
        trashEnabled = cfg.trashEnable !== false;
        trashEnableToggle.classList.toggle('active', trashEnabled);
        trashUrlGroup.style.display = trashEnabled ? 'block' : 'none';
        
        // Also save to localStorage for quick access from other pages
        localStorage.setItem('printerIp', cfg.printerIp || '');
        localStorage.setItem('printerPort', cfg.printerPort || 9100);
      } catch (err) {
        console.error('Failed to load config:', err);
        saveStatus.textContent = 'Failed to load settings';
        saveStatus.className = 'save-status error';
      }
    }

    async function loadStatus() {
      try {
        const data = await fetchJson('/api/status');
        document.getElementById('lastRun').textContent = data.lastRunAt 
          ? new Date(data.lastRunAt).toLocaleString('de-DE')
          : 'Never';
        document.getElementById('lastResult').textContent = data.lastRunResult || data.lastRunError || '--';
      } catch (err) {
        console.error('Failed to load status:', err);
      }
    }

    async function saveConfig() {
      saveStatus.textContent = 'Saving...';
      saveStatus.className = 'save-status';
      
      try {
        const updates = {
          donotickBaseUrl: fields.donotickBaseUrl.value.trim(),
          donotickUsername: fields.donotickUsername.value.trim(),
          donotickPassword: fields.donotickPassword.value,
          donotickToken: fields.donotickToken.value,
          printerIp: fields.printerIp.value.trim(),
          printerPort: Number(fields.printerPort.value) || 9100,
          dailyPrintTime: fields.dailyPrintTime.value || '08:00',
          weeklyPrintTime: fields.weeklyPrintTime.value || '08:00',
          weeklyPrintDay: Number(fields.weeklyPrintDay.value),
          trashIcalUrl: fields.trashIcalUrl.value.trim(),
          trashEnable: trashEnabled
        };
        
        await fetchJson('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        
        // Update localStorage
        localStorage.setItem('printerIp', updates.printerIp);
        localStorage.setItem('printerPort', updates.printerPort);
        
        saveStatus.textContent = '‚úì Settings saved';
        saveStatus.className = 'save-status success';
        
        setTimeout(() => {
          saveStatus.textContent = '';
        }, 3000);
      } catch (err) {
        saveStatus.textContent = 'Error: ' + err.message;
        saveStatus.className = 'save-status error';
      }
    }

    async function pingPrinter() {
      const ip = fields.printerIp.value.trim();
      if (!ip) {
        printerStatus.textContent = 'Please enter a printer IP address';
        printerStatus.className = 'status-box error';
        return;
      }
      printerStatus.textContent = 'Checking...';
      printerStatus.className = 'status-box';
      try {
        const data = await fetchJson(`/api/printer/status?printerIp=${encodeURIComponent(ip)}`);
        if (data.reachable) {
          printerStatus.textContent = `‚úì Printer ${data.ip} is reachable`;
          printerStatus.className = 'status-box success';
        } else {
          printerStatus.textContent = `‚úó Printer ${data.ip} not reachable`;
          printerStatus.className = 'status-box error';
        }
      } catch (err) {
        printerStatus.textContent = `Error: ${err.message}`;
        printerStatus.className = 'status-box error';
      }
    }

    async function printTest() {
      const ip = fields.printerIp.value.trim();
      const port = Number(fields.printerPort.value) || 9100;
      printerStatus.textContent = 'Sending test print...';
      printerStatus.className = 'status-box';
      try {
        await fetchJson('/api/printer/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ printerIp: ip, printerPort: port })
        });
        printerStatus.textContent = '‚úì Test print sent successfully';
        printerStatus.className = 'status-box success';
      } catch (err) {
        printerStatus.textContent = `Error: ${err.message}`;
        printerStatus.className = 'status-box error';
      }
    }

    // Event listeners
    document.getElementById('btnSave').onclick = saveConfig;
    document.getElementById('btnPing').onclick = pingPrinter;
    document.getElementById('btnPrintTest').onclick = printTest;

    // Load on page load
    loadConfig();
    loadStatus();
  </script>
</body>
</html>
